name: Manual Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 2.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes (markdown format)'
        required: true
        type: string
      pre_release:
        description: 'Mark as pre-release?'
        required: false
        type: boolean
        default: false
      include_legacy:
        description: 'Include GhostGMS-1.3.zip in release?'
        required: false
        type: boolean
        default: false

# Add permissions here
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Verify version in module.prop
        run: |
          if [ ! -f module.prop ]; then
            echo "Error: module.prop not found"
            exit 1
          fi
          CURRENT_VERSION=$(grep 'version=' module.prop | cut -d'=' -f2)
          if [ -z "$CURRENT_VERSION" ]; then
            echo "Error: Could not extract version from module.prop"
            exit 1
          fi
          if [ "$CURRENT_VERSION" != "${{ inputs.version }}" ]; then
            echo "Error: Version in module.prop ($CURRENT_VERSION) doesn't match input version (${{ inputs.version }})"
            exit 1
          fi
          
      - name: Verify version in update.json
        run: |
          if [ ! -f update.json ]; then
            echo "Error: update.json not found"
            exit 1
          fi
          JSON_VERSION=$(grep -o '"version": *"[^"]*"' update.json | cut -d'"' -f4)
          if [ -z "$JSON_VERSION" ]; then
            echo "Error: Could not extract version from update.json"
            exit 1
          fi
          if [ "$JSON_VERSION" != "${{ inputs.version }}" ]; then
            echo "Error: Version in update.json ($JSON_VERSION) doesn't match input version (${{ inputs.version }})"
            exit 1
          fi
          
          # Check ZIP URL in update.json
          ZIP_URL=$(grep -o '"zipUrl": *"[^"]*"' update.json | cut -d'"' -f4)
          EXPECTED_URL="https://github.com/veloxineology/GhostGMS/releases/download/${{ inputs.version }}/GhostGMS-${{ inputs.version }}.zip"
          if [ "$ZIP_URL" != "$EXPECTED_URL" ]; then
            echo "Error: zipUrl in update.json doesn't match expected format"
            echo "Expected: $EXPECTED_URL"
            echo "Found: $ZIP_URL"
            exit 1
          fi
          
      - name: Check required files
        run: |
          REQUIRED_FILES=(
            "module.prop"
            "LICENSE"
            "README.md"
            "update.json"
            "CHANGELOG.md"
            "customize.sh"
            "service.sh"
            "veloxine.sh"
            "post-fs-data.sh"
            "gmslist.txt"
            "system.prop"
          )
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -e "$file" ]; then
              echo "Error: Required file/directory '$file' not found"
              exit 1
            fi
          done
          
      - name: Create Core zip file
        run: |
          mkdir -p release_temp
          mkdir -p release_temp/config
          mkdir -p release_temp/logs
          find . -type f \
            -not -path "./release_temp/*" \
            -not -path "./.git/*" \
            -not -path "./.github/*" \
            -not -path "./.gitignore" \
            | xargs -I{} cp --parents {} release_temp/
          find release_temp -name "*.sh" -exec chmod +x {} \;
          cd release_temp
          zip -r ../GhostGMS-Core-${{ inputs.version }}.zip *
          cd ..

      - name: Create Legacy zip (GhostGMS-Legacy-1.3.zip)
        if: ${{ inputs.include_legacy }}
        run: |
          cd legacy/GhostGMS-1.3
          zip -r ../../GhostGMS-Legacy-1.3.zip *
          cd ../..
          
      - name: Check Core zip file integrity
        run: |
          if [ ! -f GhostGMS-Core-${{ inputs.version }}.zip ]; then
            echo "Error: Core zip file was not created"
            exit 1
          fi
          if [ ! -s GhostGMS-Core-${{ inputs.version }}.zip ]; then
            echo "Error: Created Core zip file is empty"
            exit 1
          fi
          echo "Checking for important files in Core zip..."
          IMPORTANT_FILES=(
            "module.prop" 
            "customize.sh" 
            "veloxine.sh"
            "post-fs-data.sh"
            "service.sh"
            "gmslist.txt"
            "system.prop"
          )
          for file in "${IMPORTANT_FILES[@]}"; do
            if ! unzip -l GhostGMS-Core-${{ inputs.version }}.zip | grep -q "$file"; then
              echo "Error: $file not found in the Core zip archive"
              exit 1
            fi
          done
          echo "All important files verified in Core zip file"
          
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            GhostGMS-Core-${{ inputs.version }}.zip
            ${{ inputs.include_legacy && 'GhostGMS-Legacy-1.3.zip' || '' }}
          tag_name: ${{ inputs.version }}
          name: GhostGMS ${{ inputs.version }}
          body: ${{ inputs.release_notes }}
          prerelease: ${{ inputs.pre_release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Cleanup
        run: |
          rm -rf release_temp
          rm -f GhostGMS-Core-${{ inputs.version }}.zip 
          rm -f GhostGMS-Legacy-1.3.zip
